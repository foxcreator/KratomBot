<?php

namespace App\Http\Controllers;

use App\Models\Member;
use App\Models\Setting;
use App\Models\Product;
use App\Models\CartItem;
use App\Models\OrderItem;
use Illuminate\Support\Facades\Log;
use Telegram\Bot\FileUpload\InputFile;
use Mockery\Exception;
use Telegram\Bot\Api;
use Telegram\Bot\Laravel\Facades\Telegram;
use App\Models\Order;
use App\Models\Brand;
use App\Models\ProductOption;
use App\Models\Subcategory;

class TelegramController extends Controller
{
    protected $telegram;
    protected $channelsUsername;
    protected $settings;

    // –î–æ–¥–∞—é –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –¥–ª—è —Å—Ç–∞–Ω—ñ–≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è
    const CHECKOUT_STATE = [
        'AWAIT_PAYMENT_TYPE' => 'await_payment_type',
        'AWAIT_RECEIPT_PHOTO' => 'await_receipt_photo',
        'AWAIT_SHIPPING_PHONE' => 'await_shipping_phone',
        'AWAIT_SHIPPING_CITY' => 'await_shipping_city',
        'AWAIT_SHIPPING_CARRIER' => 'await_shipping_carrier',
        'AWAIT_SHIPPING_OFFICE' => 'await_shipping_office',
        'AWAIT_SHIPPING_NAME' => 'await_shipping_name',
    ];

    public function __construct()
    {
        $this->telegram = new Api(env('TELEGRAM_BOT_TOKEN'));
        $this->settings = Setting::all()->pluck('value', 'key')->toArray();
    }

    public function setWebhook()
    {
        $url = env('APP_URL').'/telegram/webhook';
        $response = $this->telegram->setWebhook(['url' => $url]);

        return response()->json($response);
    }
    public function webhook()
    {
        try {
            $update = Telegram::getWebhookUpdates();

            if ($update->isType('callback_query')) {
                $chatId = $update->getCallbackQuery()->getMessage()->getChat()->getId();
                $data = $update->getCallbackQuery()->getData();
                $this->handleCallback($chatId, $data);
            } elseif ($update->isType('message')) {
                $chatId = $update->getMessage()->getChat()->getId();
                $username = $update->getMessage()->getFrom()->getUsername();
                $text = $update->getMessage()->getText();

                Member::updateOrCreate(
                    ['telegram_id' => $chatId],
                    ['username' => $username]
                );

                // –î–æ–¥–∞—é –æ–±—Ä–æ–±–∫—É —Ñ–æ—Ç–æ
                if ($update->getMessage()->has('photo')) {
                    $photoSizes = $update->getMessage()->get('photo');
                    \Log::info('webhook: photoSizes', ['type' => gettype($photoSizes), 'photoSizes' => $photoSizes]);
                    if ($photoSizes instanceof \Illuminate\Support\Collection) {
                        $photoSizes = $photoSizes->toArray();
                    }
                    if (is_array($photoSizes) && count($photoSizes) > 0) {
                        $largestPhoto = $photoSizes[array_key_last($photoSizes)];
                        \Log::info('webhook: largestPhoto', ['largestPhoto' => $largestPhoto]);
                        $this->handlePhoto($chatId, $largestPhoto);
                        return;
                    }
                }

                if ($text === '/start') {
                    $this->sendWelcome($chatId, $username);
                } else {
                    $this->handleText($chatId, $text);
                }
            }
        } catch (\Exception $exception) {
            Log::error($exception->getMessage());
        }
    }

    private function sendWelcome($chatId, $username)
    {
        $rawText = !empty($this->settings['helloMessage']) ? $this->settings['helloMessage'] : "–í—ñ—Ç–∞—î–º–æ, {{ username }}!\n\n–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é –∑ –º–µ–Ω—é –Ω–∏–∂—á–µ:";
        $text = $this->replacePlaceholders($rawText, ['username' => '@' . $username]);
        $this->sendMainMenu($chatId, $text);
        if (!empty($this->settings['channel'])) {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => $this->settings['channel']
            ]);
        }
    }

    private function sendMainMenu($chatId, $text = null)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $cartCount = $member ? $member->cart_items_count : 0;
        $keyboard = $this->getMainMenuKeyboard($chatId);
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => $text ?? '‚òù',
            'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
        ]);
    }

    private function showCart($chatId)
    {
        $member = Member::where('telegram_id', $chatId)
            ->with(['cartItems.productOption', 'cartItems.product'])
            ->first();
        if (!$member || $member->cartItems->isEmpty()) {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => 'üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è',
                'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
            ]);
            return;
        }
        $message = "üõí <b>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:</b>\n\n";
        $total = 0;
        $inlineKeyboard = [];
        foreach ($member->cartItems as $item) {
            $product = $item->product;
            $option = $item->productOption;
            $itemName = $product->name;
            $itemPrice = $option ? $option->price : $product->price;
            $itemTotal = $item->quantity * (float) $itemPrice;
            $total += $itemTotal;
            $message .= "üì¶ <b>{$itemName}</b>\n";
            if ($option) {
                $message .= "<em>{$option->name}</em>\n";
            }
            $message .= "–ö—ñ–ª—å–∫—ñ—Å—Ç—å: {$item->quantity} —à—Ç.\n";
            $message .= "–¶—ñ–Ω–∞: {$itemPrice} –≥—Ä–Ω √ó {$item->quantity} = <b>{$itemTotal} –≥—Ä–Ω</b>\n\n";

            $message .= "üì¶ <b>{$product->name}</b>\n";
            $message .= "   –ö—ñ–ª—å–∫—ñ—Å—Ç—å: {$item->quantity} —à—Ç.\n";
            $message .= "   –¶—ñ–Ω–∞: {$product->price} –≥—Ä–Ω √ó {$item->quantity} = {$itemTotal} –≥—Ä–Ω\n\n";

            $inlineKeyboard[] = [
                ['text' => '‚ûñ', 'callback_data' => 'decrease_quantity_' . $item->id],
                ['text' => $item->quantity, 'callback_data' => 'quantity_' . $item->id],
                ['text' => '‚ûï', 'callback_data' => 'increase_quantity_' . $item->id],
                ['text' => 'üóë', 'callback_data' => 'remove_from_cart_' . $item->id]
            ];
        }

        $discountPercent = isset($this->settings['telegram_channel_discount']) ? (float)$this->settings['telegram_channel_discount'] : 0;

        if ($this->isUserSubscribedToChannel($chatId) && $discountPercent > 0) {
            $discountAmount = round($total * $discountPercent / 100, 2);
            $totalWithDiscount = $total - $discountAmount;
            $message .= "\nüéÅ <b>–í–∞—à–∞ –∑–Ω–∏–∂–∫–∞: {$discountPercent}% (-{$discountAmount} –≥—Ä–Ω)</b>";
            $message .= "\nüí∏ <b>–°—É–º–∞ –∑—ñ –∑–Ω–∏–∂–∫–æ—é: {$totalWithDiscount} –≥—Ä–Ω</b>";
        } else {
            $totalWithDiscount = $total;
            $message .= "üí∞ <b>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: {$total} –≥—Ä–Ω</b>";
        }

        $inlineKeyboard[] = [
            ['text' => 'üí≥ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', 'callback_data' => 'checkout_cart'],
            ['text' => 'üóë –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'clear_cart']
        ];
        $inlineKeyboard[] = [
            ['text' => '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é', 'callback_data' => 'back_to_menu']
        ];
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => $message,
            'parse_mode' => 'HTML',
            'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
        ]);
    }

    private function checkoutCart($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();

        if (!$member || $member->cartItems->isEmpty()) {
            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => '–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è'
            ]);
            return;
        }
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –ø–µ—Ä—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ completed/cancelled)
        $hasOrders = Order::where('member_id', $member->id)->exists();
        $keyboard = [
            [['text' => 'üí≥ –ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞', 'callback_data' => 'pay_type_prepaid']],
        ];
        if (!$hasOrders) {
            $keyboard[] = [['text' => 'üöö –ù–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂', 'callback_data' => 'pay_type_cod']];
        }
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => "–û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏:\n\n<b>–ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞</b> ‚Äî –æ–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–∫—É, –ø—ñ—Å–ª—è —á–æ–≥–æ –≤–∏ –Ω–∞–¥—Å–∏–ª–∞—î—Ç–µ —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó.\n<b>–ù–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂</b> ‚Äî –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ (–¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è).",
            'parse_mode' => 'HTML',
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
        $state = $member->checkout_state ?? [];
        $state['step'] = self::CHECKOUT_STATE['AWAIT_PAYMENT_TYPE'];
        $state['cart_snapshot'] = $member->cartItems->map(function($item) {
            return [
                'product_id' => $item->product_id,
                'product_option_id' => $item->product_option_id,
                'quantity' => $item->quantity,
            ];
        })->toArray();
        $state['total'] = $member->cartItems->sum(function($item) {
            return $item->quantity * ($item->productOption ? $item->productOption->price : $item->product->price);
        });
        $member->checkout_state = $state;
        $member->save();

        $activeOrders = Order::where('member_id', $member->id)
            ->whereIn('status', ['new', 'processing'])
            ->count();

        if ($activeOrders == 0) {
            $totalAmount = 0;
            $orderItems = [];

            foreach ($member->cartItems as $cartItem) {
                $option = $cartItem->productOption;
                $product = $cartItem->product;
                $itemPrice = $option ? $option->price : $product->price;
                $itemTotal = $cartItem->quantity * (float) $itemPrice;
                $totalAmount += $itemTotal;
                $orderItems[] = [
                    'product_id' => $product->id,
                    'product_option_id' => $option ? $option->id : null,
                    'quantity' => $cartItem->quantity,
                    'price' => $itemPrice
                ];
            }

            $discountPercent = isset($this->settings['telegram_channel_discount']) ? (float)$this->settings['telegram_channel_discount'] : 0;
            $isSubscribed = $this->isUserSubscribedToChannel($chatId);
            if ($isSubscribed && $discountPercent > 0) {
                $discountAmount = round($totalAmount * $discountPercent / 100, 2);
                $totalAmount = $totalAmount - $discountAmount;
            }

            $order = Order::create([
                'member_id' => $member->id,
                'status' => 'new',
                'total_amount' => $totalAmount,
                'source' => 'cart',
                'notes' => '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –∫–æ—Ä–∑–∏–Ω–∏'
            ]);

            foreach ($orderItems as $item) {
                OrderItem::create([
                    'order_id' => $order->id,
                    'product_id' => $item['product_id'],
                    'product_option_id' => $item['product_option_id'],
                    'quantity' => $item['quantity'],
                    'price' => $item['price']
                ]);
            }

            $member->cartItems()->delete();

            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => '‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!'
            ]);

            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!\n\nüìã –ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: {$order->order_number}\nüí∞ –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: {$order->formatted_total}\n\n–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.",
                'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
            ]);
        } else {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => "–£ –≤–∞—Å –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω.",
                'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
            ]);
        }
    }

    private function clearCart($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();

        if ($member) {
            $member->cartItems()->delete();
        }

        Telegram::answerCallbackQuery([
            'callback_query_id' => $this->getCallbackQueryId(),
            'text' => '–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞'
        ]);

        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => 'üóë –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞',
            'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
        ]);
    }

    private function addToCart($chatId, $productId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $product = Product::find($productId);
        if (!$member || !$product) {
            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É'
            ]);
            return;
        }
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç–∞–∫–æ–≥–æ –∑–∞–ø–∏—Å—É
        $cartItem = CartItem::where('member_id', $member->id)
            ->where('product_id', $productId)
            ->whereNull('product_option_id')
            ->first();
        if ($cartItem) {
            $cartItem->increment('quantity');
        } else {
            try {
                CartItem::create([
                    'member_id' => $member->id,
                    'product_id' => $productId,
                    'quantity' => 1
                ]);
            } catch (\Exception $e) {
                // –Ø–∫—â–æ –¥—É–±–ª—å ‚Äî –ø—Ä–æ—Å—Ç–æ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ
                $cartItem = CartItem::where('member_id', $member->id)
                    ->where('product_id', $productId)
                    ->whereNull('product_option_id')
                    ->first();
                if ($cartItem) {
                    $cartItem->increment('quantity');
                }
            }
        }
        Telegram::answerCallbackQuery([
            'callback_query_id' => $this->getCallbackQueryId(),
            'text' => "‚úÖ {$product->name} –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"
        ]);
    }

    private function removeFromCart($chatId, $itemId)
    {
        $member = Member::where('telegram_id', $chatId)->first();

        if ($member) {
            CartItem::where('member_id', $member->id)
                   ->where('id', $itemId)
                   ->delete();
        }

        Telegram::answerCallbackQuery([
            'callback_query_id' => $this->getCallbackQueryId(),
            'text' => '–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –∫–æ—Ä–∑–∏–Ω–∏'
        ]);

        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∑–∏–Ω–∏
        $this->updateCartMessage($chatId);
    }

    private function changeQuantity($chatId, $itemId, $change)
    {
        $member = Member::where('telegram_id', $chatId)->first();

        if (!$member) {
            return;
        }

        $cartItem = CartItem::where('member_id', $member->id)
                           ->where('id', $itemId)
                           ->first();

        if (!$cartItem) {
            return;
        }

        $newQuantity = $cartItem->quantity + $change;

        if ($newQuantity <= 0) {
            $cartItem->delete();
            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => '–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –∫–æ—Ä–∑–∏–Ω–∏'
            ]);
        } else {
            $cartItem->update(['quantity' => $newQuantity]);
            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–æ: {$newQuantity}"
            ]);
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∑–∏–Ω–∏
        $this->updateCartMessage($chatId);
    }

    private function updateCartMessage($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();

        if (!$member || $member->cartItems->isEmpty()) {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => 'üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è',
                'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
            ]);
            return;
        }

        $message = "üõí <b>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:</b>\n\n";
        $total = 0;
        $inlineKeyboard = [];

        foreach ($member->cartItems as $item) {
            $product = $item->product;
            $option = $item->productOption;
            $itemName = $product->name;
            if ($option) {
                $itemName .= " ({$option->name})";
                $itemPrice = $option->price;
            } else {
                $itemPrice = $product->price;
            }
            $itemTotal = $item->quantity * (float) $itemPrice;
            $total += $itemTotal;

            $message .= "üì¶ <b>{$itemName}</b>\n";
            $message .= "   –ö—ñ–ª—å–∫—ñ—Å—Ç—å: {$item->quantity} —à—Ç.\n";
            $message .= "   –¶—ñ–Ω–∞: {$itemPrice} –≥—Ä–Ω √ó {$item->quantity} = {$itemTotal} –≥—Ä–Ω\n\n";

            // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—é
            $inlineKeyboard[] = [
                ['text' => '‚ûñ', 'callback_data' => 'decrease_quantity_' . $item->id],
                ['text' => $item->quantity, 'callback_data' => 'quantity_' . $item->id],
                ['text' => '‚ûï', 'callback_data' => 'increase_quantity_' . $item->id],
                ['text' => 'üóë', 'callback_data' => 'remove_from_cart_' . $item->id]
            ];
        }

        $message .= "üí∞ <b>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: {$total} –≥—Ä–Ω</b>";

        // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö –¥—ñ–π –∑ –∫–æ—Ä–∑–∏–Ω–æ—é
        $inlineKeyboard[] = [
            ['text' => 'üí≥ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', 'callback_data' => 'checkout_cart'],
            ['text' => 'üóë –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'clear_cart']
        ];
        $inlineKeyboard[] = [
            ['text' => '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é', 'callback_data' => 'back_to_menu']
        ];

        // –û—Ç—Ä–∏–º—É—î–º–æ ID –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        $update = Telegram::getWebhookUpdates();
        $messageId = $update->getCallbackQuery()->getMessage()->getMessageId();

        Telegram::editMessageText([
            'chat_id' => $chatId,
            'message_id' => $messageId,
            'text' => $message,
            'parse_mode' => 'HTML',
            'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
        ]);
    }

    private function getCallbackQueryId()
    {
        $update = Telegram::getWebhookUpdates();
        return $update->getCallbackQuery()->getId();
    }

    private function handleText($chatId, $text)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        if ($member && $member->checkout_state && isset($member->checkout_state['step'])) {
            $state = $member->checkout_state;
            $step = $state['step'];
            if ($step === self::CHECKOUT_STATE['AWAIT_SHIPPING_PHONE']) {
                $state['shipping_phone'] = $text;
                $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_CITY'];
                $member->checkout_state = $state;
                $member->save();
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:"
                ]);
                return;
            } elseif ($step === self::CHECKOUT_STATE['AWAIT_SHIPPING_CITY']) {
                $state['shipping_city'] = $text;
                $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_CARRIER'];
                $member->checkout_state = $state;
                $member->save();
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "–û–±–µ—Ä—ñ—Ç—å –ø–æ—à—Ç–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:",
                    'reply_markup' => json_encode(['keyboard' => [['–ù–æ–≤–∞ –ü–æ—à—Ç–∞'], ['–£–∫—Ä–ø–æ—à—Ç–∞']], 'resize_keyboard' => true])
                ]);
                return;
            } elseif ($step === self::CHECKOUT_STATE['AWAIT_SHIPPING_CARRIER']) {
                $state['shipping_carrier'] = $text;
                $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_OFFICE'];
                $member->checkout_state = $state;
                $member->save();
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:"
                ]);
                return;
            } elseif ($step === self::CHECKOUT_STATE['AWAIT_SHIPPING_OFFICE']) {
                $state['shipping_office'] = $text;
                $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_NAME'];
                $member->checkout_state = $state;
                $member->save();
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "–í–≤–µ–¥—ñ—Ç—å –ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞:"
                ]);
                return;
            } elseif ($step === self::CHECKOUT_STATE['AWAIT_SHIPPING_NAME']) {
                $state['shipping_name'] = $text;
                $member->checkout_state = $state;
                $member->save();
                $this->finalizeOrder($chatId, 'cod');
                return;
            }
        }
        $replacements = ['username' => ($member && $member->username) ? '@' . $member->username : ''];

        switch ($text) {
            case 'üì¶ –ö–∞—Ç–∞–ª–æ–≥':
                $this->sendCatalogMenu($chatId);
                break;
            case 'üéÅ –û—Ç—Ä–∏–º–∞–π –∑–Ω–∏–∂–∫—É':
                $discountInfo = $this->settings['discount_info'] ?? '–©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–Ω–∏–∂–∫—É, –ø—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª!';
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => $discountInfo,
                    'parse_mode' => 'HTML',
                    'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
                ]);
                break;
            case 'üî• –¢–æ–ø –ø—Ä–æ–¥–∞–∂':
                $products = Product::where('is_top_sales', true)->get();
                if ($products->count() > 0) {
                    foreach ($products as $index => $product) {
                        $caption = ($index+1) . ". <b>{$product->name}</b>\n";
                        $caption .= "üí∞ {$product->price} –≥—Ä–Ω";
                        $localPath = public_path($product->image_url);
                        if (file_exists($localPath)) {
                            $photo = InputFile::create($localPath, basename($localPath));
                        } else {
                            $photo = $product->image_url;
                        }
                        $inlineKeyboard = [
                            [
                                ['text' => 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ –∑–∞—Ä–∞–∑', 'callback_data' => 'buy_product_' . $product->id],
                                ['text' => '‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'add_to_cart_' . $product->id]
                            ]
                        ];
                        Telegram::sendPhoto([
                            'chat_id' => $chatId,
                            'photo' => $photo,
                            'caption' => $caption,
                            'parse_mode' => 'HTML',
                            'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
                        ]);
                    }
                } else {
                    Telegram::sendMessage([
                        'chat_id' => $chatId,
                        'text' => "–¢–æ–ø –ø—Ä–æ–¥–∞–∂ –ø–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—ñ–π."
                    ]);
                }
                $this->sendMainMenu($chatId);
                break;
            case (preg_match('/^üõí –ö–æ—Ä–∑–∏–Ω–∞/', $text) ? true : false):
                $this->showCart($chatId);
                break;
            case 'üí≥ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':
                $this->checkoutCart($chatId);
                break;
            case 'üóë –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—Ä–∑–∏–Ω—É':
                $this->clearCart($chatId);
                break;
            case '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é':
                $this->sendMainMenu($chatId);
                break;
            case 'üìò –Ø–∫ –∑–∞–º–æ–≤–∏—Ç–∏':
                $messageText = $this->settings['howOrdering'] ?? '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—è.';
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "<b>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —è–∫ –∑–∞–º–æ–≤–∏—Ç–∏:</b> \n\n" . $this->settings['howOrdering'],
                    'parse_mode' => 'HTML',
                    'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
                ]);
                $this->sendMainMenu($chatId);
                break;
            case 'üí≥ –û–ø–ª–∞—Ç–∞':
                $messageText = $this->settings['payment'] ?? '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—è.';
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "<b>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É:</b> \n\n" . $this->settings['payment'],
                    'parse_mode' => 'HTML',
                    'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
                ]);
                $this->sendMainMenu($chatId);
                break;
            case '‚≠êÔ∏è –í—ñ–¥–≥—É–∫–∏':
                $messageText = $this->settings['reviews'] ?? '–í—ñ–¥–≥—É–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.';
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => $this->settings['reviews'],
                    'parse_mode' => 'HTML',
                    'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
                ]);
                $this->sendMainMenu($chatId);
                break;
            case 'üåø Moringa':
                if ($member) $member->update(['current_brand_id' => Brand::where('name', 'Like', '%Moringa%')->first()->id]);
                $this->sendMoringaMenu($chatId);
                break;
            case 'üß™ –ê–Ω–∞–ª–æ–≥–∏':
                if ($member) $member->update(['current_brand_id' => null]);
                $this->sendAnalogsMenu($chatId);
                break;
            case '‚¨ÖÔ∏è –ù–∞–∑–∞–¥':
                if ($member) $member->update(['current_brand_id' => null]);
                $this->sendMainMenu($chatId);
                break;
            case 'üìò –ü—Ä–æ –ø—Ä–æ–¥—É–∫—Ç':
            case 'üìò –ü—Ä–æ —Ç–æ–≤–∞—Ä':
                $brand = null;
                if ($member && $member->current_brand_id) {
                    $brand = Brand::find($member->current_brand_id);
                }
                if (!$brand) {
                    $brand = Brand::where('name', 'Moringa')->first();
                }
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => '–ü—Ä–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é ' . $brand->name . ": \n\n" . $brand->description,
                    'reply_markup' => json_encode(['keyboard' => $this->getMoringaMenuKeyboard($brand, $chatId), 'resize_keyboard' => true])
                ]);
                break;
            case 'üí∞ –ü—Ä–∞–π—Å':
                $brand = null;
                if ($member && $member->current_brand_id) {
                    $brand = Brand::find($member->current_brand_id);
                }
                if (!$brand) {
                    $brand = Brand::where('name', 'Moringa')->first();
                }
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => '–ü—Ä–∞–π—Å –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é ' . $brand->name . ": \n\n" . $brand->price,
                    'parse_mode' => 'HTML',
                    'reply_markup' => json_encode(['keyboard' => $this->getMoringaMenuKeyboard($brand, $chatId), 'resize_keyboard' => true])
                ]);
                break;
            case 'üõç –¢–æ–≤–∞—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó':
                $brand = null;
                if ($member && $member->current_brand_id) {
                    $brand = Brand::find($member->current_brand_id);
                }
                if (!$brand) {
                    $brand = Brand::where('name', 'Moringa')->first();
                }
                $this->sendBrandProductsMenu($chatId, $brand->id);
                break;
            default:
                $brand = Brand::where('name', $text)->first();
                if ($brand && $member) {
                    $member->update(['current_brand_id' => $brand->id]);
                    $this->sendBrandAnalogMenu($chatId, $brand->id);
                    break;
                }

                if (str_starts_with($text, 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ ')) {
                    $productId = (int)str_replace('üõí –ü—Ä–∏–¥–±–∞—Ç–∏ ', '', $text);
                    if ($member) {
                        Order::create([
                            'member_id' => $member->id,
                            'product_id' => $productId,
                            'status' => 'new',
                        ]);
                    }
                    Telegram::sendMessage([
                        'chat_id' => $chatId,
                        'text' => '–î—è–∫—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è! –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.'
                    ]);
                    $this->sendMainMenu($chatId);
                    break;
                }
                $this->sendAnalogsMenu($chatId);
                break;
        }

        $subcategory = Subcategory::where('name', $text)->first();
        if ($subcategory) {
            $this->sendSubcategoryProductsMenu($chatId, $subcategory->id);
            return;
        }
    }

    private function sendCatalogMenu($chatId)
    {
        $keyboard = [
            ['üåø Moringa'],
            ['üß™ –ê–Ω–∞–ª–æ–≥–∏'],
            ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]],
        ];
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => '.',
            'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
        ]);
    }

    private function sendMoringaMenu($chatId)
    {
        $brand = Brand::where('id', 1)->first();
        $keyboard = $this->getMoringaMenuKeyboard($brand, $chatId);
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => '‚òù',
            'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
        ]);
    }

    private function getMoringaMenuKeyboard($brand, $chatId)
    {
        return [
            ['üìò –ü—Ä–æ –ø—Ä–æ–¥—É–∫—Ç'],
            ['üí∞ –ü—Ä–∞–π—Å'],
            ['üõç –¢–æ–≤–∞—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'],
            ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]],
        ];
    }

    private function sendAnalogsMenu($chatId)
    {
        $brands = Brand::all();
        $keyboard = [];
        foreach ($brands as $brand) {
            $keyboard[] = [$brand->name];
        }
        $keyboard[] = ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]];
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => '‚òù',
            'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
        ]);
    }

    private function sendBrandAnalogMenu($chatId, $brandId)
    {
        $brand = Brand::find($brandId);
        $keyboard = [
            ['üìò –ü—Ä–æ –ø—Ä–æ–¥—É–∫—Ç'],
            ['üí∞ –ü—Ä–∞–π—Å'],
            ['üõç –¢–æ–≤–∞—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'],
            ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]],
        ];
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => '–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ' . $brand->name,
            'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
        ]);
    }

    private function sendBrandProductsMenu($chatId, $brandId)
    {
        $subcategories = Subcategory::where('brand_id', $brandId)->get();
        if ($subcategories->count() > 0) {
            $keyboard = [];
            foreach ($subcategories as $subcategory) {
                $keyboard[] = [$subcategory->name];
            }
            $keyboard[] = ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]];
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => '–û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é:',
                'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
            ]);
        } else {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => '–£ —Ü—ñ—î—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —â–µ –Ω–µ–º–∞—î –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ–π.'
            ]);
        }
    }

    private function sendSubcategoryProductsMenu($chatId, $subcategoryId)
    {
        $products = Product::where('subcategory_id', $subcategoryId)->get();

        $keyboard = [
            ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥', $this->getCartButton($chatId)[0]],
        ];

        if ($products->count() > 0) {
            foreach ($products as $product) {
                $caption = "<b>{$product->name}</b>\n\n";
                $caption .= "{$product->description}\n\n";
                if ($product->options && $product->options->count() > 0) {
                    $inlineKeyboard = [];
                    foreach ($product->options as $option) {
                        $inlineKeyboard[] = [
                            ['text' => $option->name . ' ‚Äî ' . $option->price . ' –≥—Ä–Ω', 'callback_data' => 'choose_option_' . $option->id]
                        ];
                    }
                } else {
                    $caption .= "üí∞ {$product->price} –≥—Ä–Ω";
                    $inlineKeyboard = [
                        [
                            ['text' => 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ –∑–∞—Ä–∞–∑', 'callback_data' => 'buy_product_' . $product->id],
                            ['text' => '‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'add_to_cart_' . $product->id]
                        ]
                    ];
                }

                $caption .= "üí∞ {$product->price} –≥—Ä–Ω";
                $inlineKeyboard = [
                    [
                        ['text' => 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ –∑–∞—Ä–∞–∑', 'callback_data' => 'buy_product_' . $product->id],
                        ['text' => '‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'add_to_cart_' . $product->id]
                    ]
                ];
                if (!empty($product->image_url)) {
                    $localPath = public_path($product->image_url);
                    if (file_exists($localPath)) {
                        $photo = InputFile::create($localPath, basename($localPath));
                    } else {
                        $photo = InputFile::create($product->image_url, basename($product->image_url));
                    }
                    Telegram::sendPhoto([
                        'chat_id' => $chatId,
                        'photo' => $photo,
                        'caption' => $caption,
                        'parse_mode' => 'HTML',
                        'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
                    ]);
                } else {
                    Telegram::sendMessage([
                        'chat_id' => $chatId,
                        'text' => $caption,
                        'parse_mode' => 'HTML',
                        'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
                    ]);
                }
            }
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => '.',
                'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
            ]);
        } else {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => '–£ —Ü—ñ–π –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —â–µ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤.',
                'reply_markup' => json_encode(['keyboard' => $keyboard, 'resize_keyboard' => true])
            ]);
        }
    }

    private function getMainMenuKeyboard($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $cartCount = $member ? $member->cart_items_count : 0;
        return [
            ['üì¶ –ö–∞—Ç–∞–ª–æ–≥', 'üî• –¢–æ–ø –ø—Ä–æ–¥–∞–∂'],
            ['üéÅ –û—Ç—Ä–∏–º–∞–π –∑–Ω–∏–∂–∫—É'],
            ['üìò –Ø–∫ –∑–∞–º–æ–≤–∏—Ç–∏', 'üí≥ –û–ø–ª–∞—Ç–∞'],
            [$this->getCartButton($chatId)[0]],
            ['‚≠êÔ∏è –í—ñ–¥–≥—É–∫–∏'],
        ];
    }

    private function handleCallback($chatId, $data)
    {
        if (str_starts_with($data, 'choose_option_')) {
            $optionId = (int)str_replace('choose_option_', '', $data);
            $option = ProductOption::find($optionId);
            if ($option) {
                $inlineKeyboard = [
                    [
                        ['text' => 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ –∑–∞—Ä–∞–∑', 'callback_data' => 'buy_product_option_' . $option->id],
                        ['text' => '‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'callback_data' => 'add_to_cart_option_' . $option->id]
                    ]
                ];
                $caption = "<b>{$option->product->name}</b>\n\n";
                $caption .= "{$option->product->description}\n\n";
                $caption .= "<b>{$option->name}</b> ‚Äî {$option->price} –≥—Ä–Ω";
                $update = Telegram::getWebhookUpdates();
                $message = $update->getCallbackQuery()->getMessage();
                if ($message->has('photo')) {
                    Telegram::editMessageCaption([
                        'chat_id' => $chatId,
                        'message_id' => $message->getMessageId(),
                        'caption' => $caption,
                        'parse_mode' => 'HTML',
                        'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
                    ]);
                } else {
                    Telegram::editMessageText([
                        'chat_id' => $chatId,
                        'message_id' => $message->getMessageId(),
                        'text' => $caption,
                        'parse_mode' => 'HTML',
                        'reply_markup' => json_encode(['inline_keyboard' => $inlineKeyboard])
                    ]);
                }
            }
        } elseif (str_starts_with($data, 'buy_product_option_')) {
            $optionId = (int)str_replace('buy_product_option_', '', $data);
            $this->buyProductOption($chatId, $optionId);
        } elseif (str_starts_with($data, 'add_to_cart_option_')) {
            $optionId = (int)str_replace('add_to_cart_option_', '', $data);
            $this->addToCartOption($chatId, $optionId);
        } elseif (str_starts_with($data, 'buy_product_')) {
            $productId = (int)str_replace('buy_product_', '', $data);
            $member = Member::where('telegram_id', $chatId)->first();
            $product = Product::find($productId);
            $activeOrders = Order::where('member_id', $member->id)
                        ->whereIn('status', ['new', 'processing'])
                        ->count();
            if ($activeOrders == 0) {
                if ($member && $product) {
                    $order = Order::create([
                        'member_id' => $member->id,
                        'status' => 'new',
                        'total_amount' => $product->price,
                        'source' => 'direct',
                        'notes' => '–ü—Ä—è–º–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É'
                    ]);

                    OrderItem::create([
                        'order_id' => $order->id,
                        'product_id' => $productId,
                        'quantity' => 1,
                        'price' => $product->price
                    ]);
                }

                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\nüìã –ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: {$order->order_number}\nüí∞ –°—É–º–∞: {$order->formatted_total}\n\n–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω."
                ]);
                $this->sendMainMenu($chatId);
            } else {
                Telegram::sendMessage([
                    'chat_id' => $chatId,
                    'text' => "–£ –≤–∞—Å –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω."
                ]);
            }
        } elseif (str_starts_with($data, 'add_to_cart_')) {
            $productId = (int)str_replace('add_to_cart_', '', $data);
            $this->addToCart($chatId, $productId);
        } elseif (str_starts_with($data, 'remove_from_cart_')) {
            $itemId = (int)str_replace('remove_from_cart_', '', $data);
            $this->removeFromCart($chatId, $itemId);
        } elseif (str_starts_with($data, 'increase_quantity_')) {
            $itemId = (int)str_replace('increase_quantity_', '', $data);
            $this->changeQuantity($chatId, $itemId, 1);
        } elseif (str_starts_with($data, 'decrease_quantity_')) {
            $itemId = (int)str_replace('decrease_quantity_', '', $data);
            $this->changeQuantity($chatId, $itemId, -1);
        } elseif ($data === 'checkout_cart') {
            $this->checkoutCart($chatId);
        } elseif ($data === 'clear_cart') {
            $this->clearCart($chatId);
        } elseif ($data === 'back_to_menu') {
            $this->sendMainMenu($chatId);
        } elseif (str_starts_with($data, 'show_subcategory_')) {
            $subcategoryId = (int)str_replace('show_subcategory_', '', $data);
            $this->sendSubcategoryProductsMenu($chatId, $subcategoryId);
        } elseif ($data === 'pay_type_prepaid') {
            $this->startPrepaidCheckout($chatId);
            return;
        } elseif ($data === 'pay_type_cod') {
            $this->startCodCheckout($chatId);
            return;
        }
    }

    private function replacePlaceholders(?string $text, array $data): string
    {
        if (empty($text)) {
            return '';
        }
        foreach ($data as $key => $value) {
            $text = str_replace("{{{$key}}}", $value, $text);
            $text = str_replace("{{ {$key} }}", $value, $text);
        }
        return $text;
    }

    private function buyProductOption($chatId, $optionId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $option = ProductOption::find($optionId);
        $product = $option ? $option->product : null;
        $activeOrders = Order::where('member_id', $member->id)
            ->whereIn('status', ['new', 'processing'])
            ->count();
        if ($activeOrders == 0 && $member && $option && $product) {
            $order = Order::create([
                'member_id' => $member->id,
                'status' => 'new',
                'total_amount' => $option->price,
                'source' => 'direct',
                'notes' => '–ü—Ä—è–º–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É —Ç–æ–≤–∞—Ä—É'
            ]);
            OrderItem::create([
                'order_id' => $order->id,
                'product_id' => $product->id,
                'product_option_id' => $option->id,
                'quantity' => 1,
                'price' => $option->price
            ]);
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\nüìã –ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: {$order->order_number}\nüí∞ –°—É–º–∞: {$order->formatted_total}\n\n–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω."
            ]);
            $this->sendMainMenu($chatId);
        } else {
            Telegram::sendMessage([
                'chat_id' => $chatId,
                'text' => "–£ –≤–∞—Å –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 15 —Ö–≤–∏–ª–∏–Ω."
            ]);
        }
    }

    private function addToCartOption($chatId, $optionId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $option = ProductOption::find($optionId);
        $product = $option ? $option->product : null;
        if (!$member || !$option || !$product) {
            Telegram::answerCallbackQuery([
                'callback_query_id' => $this->getCallbackQueryId(),
                'text' => '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É —Ç–æ–≤–∞—Ä—É'
            ]);
            return;
        }
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç–∞–∫–æ–≥–æ –∑–∞–ø–∏—Å—É
        $cartItem = CartItem::where('member_id', $member->id)
            ->where('product_id', $product->id)
            ->where('product_option_id', $option->id)
            ->first();

        \Log::info('addToCartOption', [
            'member_id' => $member->id,
            'product_id' => $product->id,
            'product_option_id' => $option->id,
            'existing' => $cartItem ? $cartItem->id : null
        ]);

        if ($cartItem) {
            $cartItem->increment('quantity');
        } else {
            try {
                CartItem::create([
                    'member_id' => $member->id,
                    'product_id' => $product->id,
                    'product_option_id' => $option->id,
                    'quantity' => 1
                ]);
            } catch (\Exception $e) {
                \Log::error('CartItem create error', [
                    'member_id' => $member->id,
                    'product_id' => $product->id,
                    'product_option_id' => $option->id,
                    'error' => $e->getMessage()
                ]);
                // –Ø–∫—â–æ –¥—É–±–ª—å ‚Äî –ø—Ä–æ—Å—Ç–æ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î–º–æ
                $cartItem = CartItem::where('member_id', $member->id)
                    ->where('product_id', $product->id)
                    ->where('product_option_id', $option->id)
                    ->first();
                if ($cartItem) {
                    $cartItem->increment('quantity');
                }
            }
        }
        Telegram::answerCallbackQuery([
            'callback_query_id' => $this->getCallbackQueryId(),
            'text' => "‚úÖ {$product->name} ({$option->name}) –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"
        ]);
    }

    private function startPrepaidCheckout($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $state = $member->checkout_state ?? [];
        $state['step'] = self::CHECKOUT_STATE['AWAIT_RECEIPT_PHOTO'];
        $member->checkout_state = $state;
        $member->save();
        $requisites = $this->settings['payment'] ?? '–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏: ...';
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => "<b>–û–ø–ª–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</b>\n\n$requisites\n\n–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó —É —Ü–µ–π —á–∞—Ç.",
            'parse_mode' => 'HTML',
        ]);
    }

    private function startCodCheckout($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $state = $member->checkout_state ?? [];
        $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_PHONE'];
        $member->checkout_state = $state;
        $member->save();
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (—É —Ñ–æ—Ä–º–∞—Ç—ñ +380...)"
        ]);
    }

    private function finalizeOrder($chatId, $paymentType)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $state = $member->checkout_state;
        $cartSnapshot = $state['cart_snapshot'] ?? [];
        $total = $state['total'] ?? 0;
        $order = Order::create([
            'member_id' => $member->id,
            'status' => 'new',
            'total_amount' => $total,
            'source' => 'cart',
            'notes' => '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –±–æ—Ç–∞',
            'payment_type' => $paymentType,
            'payment_receipt' => $state['payment_receipt'] ?? null,
            'shipping_phone' => $state['shipping_phone'] ?? null,
            'shipping_city' => $state['shipping_city'] ?? null,
            'shipping_carrier' => $state['shipping_carrier'] ?? null,
            'shipping_office' => $state['shipping_office'] ?? null,
            'shipping_name' => $state['shipping_name'] ?? null,
        ]);
        foreach ($cartSnapshot as $item) {
            OrderItem::create([
                'order_id' => $order->id,
                'product_id' => $item['product_id'],
                'product_option_id' => $item['product_option_id'],
                'quantity' => $item['quantity'],
                'price' => $item['product_option_id'] ? ProductOption::find($item['product_option_id'])->price : Product::find($item['product_id'])->price,
            ]);
        }
        $member->cartItems()->delete();
        $member->checkout_state = null;
        $member->save();
        Telegram::sendMessage([
            'chat_id' => $chatId,
            'text' => "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!\n\n–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.",
            'reply_markup' => json_encode(['keyboard' => $this->getMainMenuKeyboard($chatId), 'resize_keyboard' => true])
        ]);
    }

    public function handlePhoto($chatId, $photo)
    {
        \Log::info('handlePhoto: start', ['chatId' => $chatId, 'photo' => $photo]);
        $member = Member::where('telegram_id', $chatId)->first();
        if ($member && $member->checkout_state && isset($member->checkout_state['step']) && $member->checkout_state['step'] === self::CHECKOUT_STATE['AWAIT_RECEIPT_PHOTO']) {
            $state = $member->checkout_state;
            $fileId = $photo['file_id'] ?? null;
            \Log::info('handlePhoto: fileId', ['fileId' => $fileId]);
            if ($fileId) {
                try {
                    $file = Telegram::getFile(['file_id' => $fileId]);
                    $filePath = $file->get('file_path');
                    \Log::info('handlePhoto: filePath', ['filePath' => $filePath]);
                    $localPath = storage_path('app/public/payments/' . uniqid('receipt_') . '.jpg');
                    $url = 'https://api.telegram.org/file/bot' . env('TELEGRAM_BOT_TOKEN') . '/' . $filePath;
                    \Log::info('handlePhoto: url', ['url' => $url, 'localPath' => $localPath]);
                    $fileContent = @file_get_contents($url);
                    if ($fileContent === false) {
                        \Log::error('handlePhoto: file_get_contents failed', ['url' => $url]);
                    } else {
                        $result = @file_put_contents($localPath, $fileContent);
                        \Log::info('handlePhoto: file_put_contents', ['result' => $result, 'localPath' => $localPath]);
                        if ($result === false) {
                            \Log::error('handlePhoto: file_put_contents failed', ['localPath' => $localPath]);
                        } else {
                            $state['payment_receipt'] = basename($localPath);
                            $state['step'] = self::CHECKOUT_STATE['AWAIT_SHIPPING_PHONE'];
                            $member->checkout_state = $state;
                            $member->save();
                            \Log::info('handlePhoto: state updated', ['state' => $state]);
                            Telegram::sendMessage([
                                'chat_id' => $chatId,
                                'text' => "–î—è–∫—É—î–º–æ! –¢–µ–ø–µ—Ä –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (—É —Ñ–æ—Ä–º–∞—Ç—ñ +380...):"
                            ]);
                            return;
                        }
                    }
                } catch (\Exception $e) {
                    \Log::error('handlePhoto: exception', ['error' => $e->getMessage()]);
                }
            }
        }
        \Log::info('handlePhoto: end (no action)', ['chatId' => $chatId]);
        // ... —ñ—Å–Ω—É—é—á–∏–π handlePhoto ...
    }

    private function getCartButton($chatId)
    {
        $member = Member::where('telegram_id', $chatId)->first();
        $cartCount = $member ? $member->cart_items_count : 0;
        return ['üõí –ö–æ—Ä–∑–∏–Ω–∞' . ($cartCount > 0 ? " ({$cartCount})" : '')];
    }

    private function isUserSubscribedToChannel($chatId)
    {
        $channelUsername = $this->settings['telegram_channel_username'] ?? '@auraaashopp';
        try {
            $member = $this->telegram->getChatMember([
                'chat_id' => $channelUsername,
                'user_id' => $chatId
            ]);
            return $member->status !== 'left';
        } catch (\Exception $e) {
            return false;
        }
    }
}
