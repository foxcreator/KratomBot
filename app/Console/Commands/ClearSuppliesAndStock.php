<?php

namespace App\Console\Commands;

use App\Models\Supply;
use App\Models\SupplyItem;
use App\Models\ProductOption;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;

class ClearSuppliesAndStock extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'clear:supplies-stock 
                            {--force : –í–∏–∫–æ–Ω–∞—Ç–∏ –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è}
                            {--dry-run : –ü–æ–∫–∞–∑–∞—Ç–∏ —â–æ –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ –±–µ–∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = '–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤ —Ç–∞ —Å–∫–∏–Ω—É—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥—ñ';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('üßπ –ö–æ–º–∞–Ω–¥–∞ –æ—á–∏—â–µ–Ω–Ω—è –ø–æ—Å—Ç–∞–≤–æ–∫ —Ç–∞ —Å–∫–ª–∞–¥—É');
        $this->newLine();

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ–ø—Ü—ñ—ó
        $force = $this->option('force');
        $dryRun = $this->option('dry-run');

        if ($dryRun) {
            $this->warn('üîç –†–ï–ñ–ò–ú –ü–ï–†–ï–ì–õ–Ø–î–£ - –Ω—ñ—á–æ–≥–æ –Ω–µ –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ');
            $this->newLine();
        }

        // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        $suppliesCount = Supply::count();
        $supplyItemsCount = SupplyItem::count();
        $productOptionsWithStock = ProductOption::where('in_stock', true)->count();

        $this->info('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è:');
        $this->table(
            ['–¢–∏–ø –¥–∞–Ω–∏—Ö', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤'],
            [
                ['–ü–æ—Å—Ç–∞–≤–∫–∏ (Supply)', $suppliesCount],
                ['–ï–ª–µ–º–µ–Ω—Ç–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ (SupplyItem)', $supplyItemsCount],
                ['–û–ø—Ü—ñ—ó —Ç–æ–≤–∞—Ä—ñ–≤ –∑ —Ç–æ–≤–∞—Ä–æ–º –Ω–∞ —Å–∫–ª–∞–¥—ñ', $productOptionsWithStock],
            ]
        );

        if ($suppliesCount === 0 && $supplyItemsCount === 0) {
            $this->info('‚úÖ –ù–µ–º–∞—î –ø–æ—Å—Ç–∞–≤–æ–∫ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è');
            return 0;
        }

        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
        $this->warn('‚ö†Ô∏è  –£–í–ê–ì–ê! –¶—è –∫–æ–º–∞–Ω–¥–∞:');
        $this->warn('   ‚Ä¢ –í–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤');
        $this->warn('   ‚Ä¢ –í–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø–æ—Å—Ç–∞–≤–æ–∫');
        $this->warn('   ‚Ä¢ –°–∫–∏–Ω–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥—ñ –¥–æ 0');
        $this->warn('   ‚Ä¢ –ù–ï —Ç–æ—Ä–∫–Ω–µ—Ç—å—Å—è —Å–∞–º–∏—Ö –æ–ø—Ü—ñ–π —Ç–æ–≤–∞—Ä—ñ–≤');
        $this->warn('   ‚Ä¢ –¶—è –¥—ñ—è –ù–ï–ó–í–û–†–û–¢–ù–ê!');
        $this->newLine();

        if (!$force && !$dryRun) {
            if (!$this->confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
                $this->info('‚ùå –û–ø–µ—Ä–∞—Ü—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ');
                return 0;
            }
        }

        if ($dryRun) {
            $this->info('üîç –†–µ–∂–∏–º –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            return 0;
        }

        // –í–∏–∫–æ–Ω—É—î–º–æ –æ—á–∏—â–µ–Ω–Ω—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
        try {
            DB::transaction(function () {
                $this->info('üîÑ –ü–æ—á–∏–Ω–∞—î–º–æ –æ—á–∏—â–µ–Ω–Ω—è...');

                // 1. –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—è—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ supply_item_id –≤ order_items
                $this->info('   ‚Ä¢ –û—á–∏—â–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö...');
                DB::table('order_items')->update(['supply_item_id' => null]);
                $this->info('   ‚úÖ –ü–æ—Å–∏–ª–∞–Ω–Ω—è –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö –æ—á–∏—â–µ–Ω–æ');

                // 2. –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø–æ—Å—Ç–∞–≤–æ–∫
                $this->info('   ‚Ä¢ –í–∏–¥–∞–ª—è—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø–æ—Å—Ç–∞–≤–æ–∫...');
                SupplyItem::query()->delete();
                $this->info('   ‚úÖ –ï–ª–µ–º–µ–Ω—Ç–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–æ');

                // 3. –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –ø–æ—Å—Ç–∞–≤–∫–∏
                $this->info('   ‚Ä¢ –í–∏–¥–∞–ª—è—î–º–æ –ø–æ—Å—Ç–∞–≤–∫–∏...');
                Supply::query()->delete();
                $this->info('   ‚úÖ –ü–æ—Å—Ç–∞–≤–∫–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');

                // 4. –°–∫–∏–¥–∞—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥—ñ (–ù–ï –≤–∏–¥–∞–ª—è—î–º–æ –æ–ø—Ü—ñ—ó!)
                $this->info('   ‚Ä¢ –°–∫–∏–¥–∞—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥—ñ...');
                ProductOption::query()->update([
                    'in_stock' => false,
                    'current_quantity' => 0,
                    'current_purchase_price' => 0,
                ]);
                $this->info('   ‚úÖ –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ —Å–∫–∏–Ω—É—Ç–æ (–æ–ø—Ü—ñ—ó –∑–∞–ª–∏—à–∏–ª–∏—Å—è)');

                $this->info('‚úÖ –û—á–∏—â–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
            });

        } catch (\Exception $e) {
            $this->error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ—á–∏—â–µ–Ω–Ω—è: ' . $e->getMessage());
            return 1;
        }

        $this->newLine();
        $this->info('üéâ –í—Å—ñ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ—á–∏—â–µ–Ω–æ, —Å–∫–ª–∞–¥ —Å–∫–∏–Ω—É—Ç–æ!');
        $this->info('üí° –û–ø—Ü—ñ—ó —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞–ª–∏—à–∏–ª–∏—Å—è, —Ç–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—ñ –ø–æ—Å—Ç–∞–≤–∫–∏');

        return 0;
    }
}